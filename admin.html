<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zion Command Deck | Admin</title>
<style>
  /* --- DARK THEME & CORE STYLES --- */
  :root { 
    --bg: #121212; 
    --card-bg: #1e1e1e; 
    --text: #e0e0e0; 
    --accent: #004aad; 
    --success: #00c853;
    --danger: #d32f2f;
    --warning: #ffc107;
  }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; 
    background: var(--bg); color: var(--text); 
    margin: 0; padding: 0;
  }

  /* --- LOGIN OVERLAY --- */
  #loginOverlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: #000; z-index: 9999; 
    display: flex; flex-direction: column; justify-content: center; align-items: center; 
  }
  #passInput { 
    padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 1px solid #333; 
    background: #222; color: white; text-align: center; margin-bottom: 15px;
  }

  /* --- MAIN DASHBOARD LAYOUT --- */
  .main-wrapper { 
    max-width: 1200px; margin: 0 auto; padding: 20px; display: none; /* Hidden until login */
  }

  h1 { text-align: center; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 30px; }

  /* TOOL GRID (VIN & LINKS) */
  .tool-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px; margin-bottom: 40px;
  }

  .panel {
    background: var(--card-bg); border: 1px solid #333;
    padding: 20px; border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }

  h3 { margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; color: #888; font-size: 0.9rem; text-transform: uppercase; }

  /* BUTTONS & LINKS */
  .admin-btn {
    display: block; width: 100%; padding: 12px; margin-bottom: 8px;
    background: #2b2b2b; color: #ccc; text-decoration: none;
    text-align: center; border-radius: 4px; font-weight: bold; border: 1px solid #333;
    transition: 0.2s; box-sizing: border-box;
  }
  .admin-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
  .btn-green { border-left: 4px solid var(--success); }

  /* VIN TOOL */
  input.vin-input { 
    width: 100%; padding: 12px; background: #000; border: 1px solid #444; 
    color: var(--success); border-radius: 4px; box-sizing: border-box; 
    font-family: monospace; letter-spacing: 2px; text-transform: uppercase; font-size: 1.1rem;
  }
  .result-box {
    margin-top: 15px; padding: 15px; background: #000; 
    border: 1px solid #333; min-height: 120px; 
    font-family: monospace; color: var(--success); white-space: pre-wrap;
    font-size: 0.9rem;
  }

  /* --- LIVE FEED SECTION --- */
  .feed-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
  
  .lead-card {
    background: var(--card-bg); border-left: 5px solid #555;
    padding: 20px; margin-bottom: 15px; border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3); position: relative;
  }
  
  /* STATUS COLORS */
  .status-New { border-left-color: var(--danger); }
  .status-Working { border-left-color: var(--warning); }
  .status-Booked { border-left-color: var(--success); opacity: 0.7; }

  .lead-name { font-size: 1.3rem; font-weight: bold; color: white; margin-bottom: 5px; }
  .lead-vehicle { color: var(--accent); font-weight: 700; font-size: 1.1rem; margin-bottom: 5px; }
  .lead-info { color: #999; font-size: 0.9rem; margin-bottom: 15px; }
  .badge-risk { background: var(--danger); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; vertical-align: middle; margin-left: 8px; }

  /* ACTION BAR */
  .action-bar { display: flex; gap: 10px; }
  .action-btn { 
    flex: 1; padding: 10px; border: none; border-radius: 4px; 
    font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; font-size: 0.8rem;
  }
  .btn-call { background: var(--success); flex: 2; }
  .btn-work { background: #444; }
  .btn-book { background: #444; }
  .btn-work:hover { background: var(--warning); color: black; }
  .btn-book:hover { background: var(--accent); }

  /* REFRESH SPINNER */
  .refresh-btn { background: none; border: 1px solid #555; color: #555; padding: 5px 15px; border-radius: 20px; cursor: pointer; }
  .refresh-btn:hover { color: white; border-color: white; }

</style>
</head>
<body>

<div id="loginOverlay">
  <img src="https://m.zionautoglass.com/zionlogo.jpg" style="width:250px; margin-bottom:30px; border-radius:10px;">
  <input type="password" id="passInput" placeholder="ENTER ACCESS CODE">
  <button onclick="checkPass()" class="admin-btn" style="width:200px; background:var(--accent); color:white;">UNLOCK SYSTEM</button>
</div>

<div class="main-wrapper" id="dashboard">
  
  <h1>Zion Command Deck</h1>

  <div class="tool-grid">
    
    <div class="panel">
      <h3>Quick Access</h3>
      <a href="https://docs.google.com/spreadsheets" target="_blank" class="admin-btn btn-green">üìä Open Google Sheet</a>
      <a href="https://squareup.com/dashboard" target="_blank" class="admin-btn">üí≥ Square Dashboard</a>
      <a href="https://ads.google.com" target="_blank" class="admin-btn">üì¢ Google Ads</a>
      <a href="https://dash.cloudflare.com" target="_blank" class="admin-btn">‚òÅÔ∏è Cloudflare</a>
    </div>

    <div class="panel">
      <h3>VIN Intelligence</h3>
      <input type="text" id="vinInput" class="vin-input" placeholder="ENTER 17-DIGIT VIN" maxlength="17">
      <button onclick="decodeVIN()" class="admin-btn" style="margin-top:10px; background:var(--accent); color:white;">DECODE</button>
      <div id="vinResult" class="result-box">SYSTEM READY...</div>
    </div>

  </div>

  <div class="feed-header">
    <h3 style="border:none; color:white; font-size:1.2rem; margin:0;">üî¥ Live Lead Feed</h3>
    <button onclick="loadFeed()" class="refresh-btn">‚Üª Refresh</button>
  </div>
  
  <div id="feed">
    <div style="text-align:center; padding:40px; color:#555;">Loading secure data...</div>
  </div>

</div>

<script>
  // --- CONFIGURATION ---
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy3anFgwk-7c1UFr9J0Qb8D4h5awGmVlsLjW_uAs0qRfusgJQSqsQllQk0FZtTTR0l/exec';

  // 1. LOGIN LOGIC
  function checkPass() {
    const input = document.getElementById('passInput');
    if(input.value.toLowerCase() === 'zion') {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadFeed(); // Auto-load data on login
    } else { 
      input.style.borderColor = 'red';
      input.value = '';
      input.placeholder = 'ACCESS DENIED';
    }
  }

  // 2. VIN DECODER LOGIC
  function decodeVIN() {
    const vin = document.getElementById('vinInput').value.trim();
    const resBox = document.getElementById('vinResult');
    
    if(vin.length < 17) {
        resBox.innerText = "ERROR: VIN MUST BE 17 CHARACTERS.";
        return;
    }

    resBox.innerText = "ACCESSING NHTSA DATABASE...";
    
    fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`)
      .then(r => r.json())
      .then(data => {
        const res = data.Results;
        const findVal = (field) => res.find(x => x.Variable === field)?.Value || "N/A";
        
        resBox.innerText = 
          `YEAR:  ${findVal("Model Year")}\n` +
          `MAKE:  ${findVal("Make")}\n` +
          `MODEL: ${findVal("Model")}\n` +
          `BODY:  ${findVal("Body Class")}\n` +
          `PLANT: ${findVal("Plant City")}`;
      })
      .catch(err => { resBox.innerText = "CONNECTION FAILURE."; });
  }

  // 3. LIVE FEED LOGIC
  function loadFeed() {
    const feedContainer = document.getElementById('feed');
    feedContainer.style.opacity = "0.5"; // Dim while loading

    fetch(SCRIPT_URL)
    .then(r => r.json())
    .then(data => {
      feedContainer.innerHTML = '';
      feedContainer.style.opacity = "1";

      if(data.result === 'error') {
         feedContainer.innerHTML = '<div style="color:red; text-align:center;">Feed Error. Check Script.</div>';
         return;
      }

      data.forEach(lead => {
        // Security Badge Logic
        let riskBadge = '';
        if(lead.securityRisk && (lead.securityRisk.includes('VPN') || lead.securityRisk.includes('Proxy'))) {
            riskBadge = '<span class="badge-risk">‚ö†Ô∏è VPN DETECTED</span>';
        }

        // Create Card HTML
        let html = `
          <div class="lead-card status-${lead.status || 'New'}">
            <div class="lead-name">${lead.name} ${riskBadge}</div>
            <div class="lead-vehicle">${lead.vehicle}</div>
            <div class="lead-info">
               ${lead.glass}<br>
               <span style="color:#666;">${lead.timestamp} ‚Ä¢ ${lead.source}</span>
            </div>
            
            <div class="action-bar">
              <a href="tel:${lead.phone}" style="flex:2; text-decoration:none;">
                <button class="action-btn btn-call">üìû Call Now</button>
              </a>
              <button onclick="updateStatus(${lead.row}, 'Working')" class="action-btn btn-work">Work</button>
              <button onclick="updateStatus(${lead.row}, 'Booked')" class="action-btn btn-book">Book</button>
            </div>
          </div>`;
        
        feedContainer.innerHTML += html;
      });
    })
    .catch(err => {
      feedContainer.innerHTML = '<div style="color:#666; text-align:center;">Waiting for Feed Data...<br>(Ensure doGet is active in Google Script)</div>';
      feedContainer.style.opacity = "1";
    });
  }

  // 4. UPDATE STATUS LOGIC
  function updateStatus(row, status) {
    // Optimistic UI update (optional, but makes it feel fast)
    // alert("Updating..."); 

    const fd = new FormData(); 
    fd.append('action', 'update_status'); 
    fd.append('row', row); 
    fd.append('status', status);

    fetch(SCRIPT_URL, { method: 'POST', body: fd, mode: 'no-cors' })
    .then(() => {
      // Reload feed to see changes
      setTimeout(loadFeed, 1000); 
    });
  }

  // Auto-refresh feed every 60 seconds
  setInterval(loadFeed, 60000); 

</script>
</body>
</html>
